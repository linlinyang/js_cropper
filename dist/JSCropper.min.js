!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):(e=e||self).JSCropper=o()}(this,function(){"use strict";var o=Object.prototype.toString;function i(e){return{"[object Object]":"object","[object Array]":"array","[object Number]":"number","[object Boolean]":"boolean","[object String]":"string","[object Function]":"function","[object Undefined]":"undefined","[object Null]":"null"}[o.call(e)]}function f(e,o,t){var n=e.width,i=e.height,r=e.getBoundingClientRect(),a=r.width,c=r.height;return{x:n/a*(o-r.left),y:i/c*(t-r.top)}}var c=Object.prototype.hasOwnProperty;"function"!==i(Object.assign)&&Object.defineProperty(Object,"assign",{value:function(e){var o=arguments;if(null===n)return n;for(var t=arguments.length,n=Object(e),i=1;i<t;i++){var r=o[i];for(var a in r)c.call(r,a)&&(n[a]=r[a])}return n},writable:!0,configurable:!0,enumerable:!1});var u=[];function t(e,o,t,n){void 0===n&&(n=!1),e.addEventListener(o,t,n),u.push({el:e,type:o,handler:t,options:n})}function p(e){return e.changedTouches?e.changedTouches[0]:e}function s(e,o){return Math.floor(e)+o%2/2}function b(e,o,t,n){void 0===n&&(n=!1);var i=e.lineWidth;n?e.moveTo(s(o,i),s(t,i)):e.moveTo(o,t)}function _(e,o,t,n){void 0===n&&(n=!1);var i=e.lineWidth;n?e.lineTo(s(o,i),s(t,i)):e.lineTo(o,t)}function y(e,o,t,n,i,r,a){void 0===r&&(r=!1),void 0===a&&(a=!1);var c=e.lineWidth,d=o+n,g=t+i;a&&(o=s(o,c),t=s(t,c),d=s(o+n,c),g=s(t+i,c)),r?(e.moveTo(o,t),e.lineTo(o,g),e.lineTo(d,g),e.lineTo(d,t)):(e.moveTo(o,t),e.lineTo(d,t),e.lineTo(d,g),e.lineTo(o,g)),e.closePath()}function w(e,o,t,n,i,r,a){void 0===r&&(r=5),void 0===a&&(a=!1);for(var c=function(e,o,t,n){return Math.sqrt(Math.pow(t-e,2)+Math.pow(n-o,2))}(o,t,n,i),d=Math.floor(c/r),g=(n-o)/d,s=(i-t)/d,u=0;u<d;u++){var h=o+u*g,l=t+u*s;1&u?_(e,h,l,a):b(e,h,l,a)}}function r(e){var o=e.width,t=e.height,n=e._zoom,i=e.cropperWidth,r=e.cropperHeight;e._x=(i-o)*n/2,e._y=(r-t)*n/2}function n(e){var o=e.bufferCanvas,t=e._x,n=e._y;void 0!==t&&void 0!==n||r(e);var i=o.getContext("2d");i.save(),function(e){var o=e.bufferCanvas,t=e.cropperWidth,n=e.cropperHeight,i=e.width,r=e.height,a=e._x,c=e._y,d=e._zoom,g=e.isDragging,s=o.getContext("2d");s.save(),s.beginPath(),y(s,0,0,t*d,n*d),y(s,a,c,i*d,r*d,!0),s.fillStyle=g?e.selectBackColor:e.inSelectBackColor,s.fill(),s.restore()}(e),function(e){var o=e.bufferCanvas,t=e.width,n=e.height,i=e._x,r=e._y,a=e._zoom,c=e.edgeLineColor,d=e.edgeLineWidth,g=o.getContext("2d"),s=t*a,u=n*a;g.strokeStyle=c,g.save(),g.lineWidth=Math.pow(a,2),y(g,i,r,s,u,!1,!0),w(g,i,r+u/3,i+s,r+u/3,5*a,!0),w(g,i,r+2*u/3,i+s,r+2*u/3,5*a,!0),w(g,i+s/3,r,i+s/3,r+u,5*a,!0),w(g,i+2*s/3,r,i+2*s/3,r+u,5*a,!0),g.stroke(),g.restore(),g.save();var h=d*a,l=i-(g.lineWidth=h)/2,f=r-h/2+1,p=i+s+h/2,v=r+u+h/2,m=.1*Math.min(s,u);g.beginPath(),b(g,l,f,!0),_(g,l+m,f,!0),b(g,p-m,f,!0),_(g,p,f,!0),_(g,p,f+m,!0),b(g,p,v-m,!0),_(g,p,v,!0),_(g,p-m,v,!0),b(g,l+m,v,!0),_(g,l,v,!0),_(g,1+l,v-m,!0),b(g,1+l,f+m,!0),_(g,1+l,f-h/2,!0),g.stroke(),g.restore()}(e),i.restore()}function a(e,o){var t=e[o];"function"==typeof t&&t.call(e)}var d={cropperWidth:800,cropperHeight:600,width:300,height:300,shadowColor:"rgba(0,0,0,0.7)",edgeLineColor:"#fff",edgeLineWidth:3,dashLineColor:"rgba(255,255,255,0.8)",quality:1,imgType:"image/png",inSelectBackColor:"rgba(0,0,0,0.6)",selectBackColor:"rgba(0,0,0,0.4)",debug:!1};var g=1;function h(e,o,t,n){void 0===n&&(n=1);var i=e.getContext("2d"),r=o*n,a=t*n;return e.width=r,e.height=a,i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.msImageSmoothingEnabled=!1,i.imageSmoothingEnabled=!1,{zoomWidth:r,zoomHeight:a}}function v(e,o,t){var n=e.canvas,i=e._zoom,r=e.width,a=e.height,c=e._x,d=e._y;return c<o&&o<c+r*i&&d<t&&t<d+a*i?(n.style.cursor="move",!0):!(n.style.cursor="default")}var m=!1,x=0,C=0;function l(d){return function(e){var o=p(e),t=d.canvas,n=d._x,i=d._y,r=f(t,o.clientX,o.clientY),a=r.x,c=r.y;m=v(d,a,c),x=a-n,C=c-i,d.isDragging=m}}function j(l){return function(e){var o=p(e),t=l.canvas,n=l.width,i=l.height,r=l.cropperWidth,a=l.cropperHeight,c=l._zoom,d=f(t,o.clientX,o.clientY),g=d.x,s=d.y,u=(r-n)*c,h=(a-i)*c;v(l,g,s),m&&(l._x=Math.max(0,Math.min(u,g-x)),l._y=Math.max(0,Math.min(h,s-C)),l._redraw(),l.debug&&console.log("拖动裁剪框：(X: "+l._x+", Y: "+l._y+")"))}}function S(o){return function(e){o.isDragging=m=!1,o._redraw()}}var W=String.prototype.toLowerCase;function z(){throw a(jc,"imgLoaded"),new Error("Load image fail, please check your image")}function I(e){if(e._sourceImg){!function(e){if(e._sourceImg){var o=e.cropperWidth,t=e.cropperHeight,n=e._zoom,i=e._sourceImg,r=i.width,a=i.height,c=Math.min(o/r,t/a);Object.assign(e,{_imgWidth:r*c*n,_imgHeight:a*c*n})}}(e);var o=e.bufferCanvas,t=e._sourceImg,n=e.cropperWidth,i=e.cropperHeight,r=e._imgWidth,a=e._imgHeight,c=e._zoom,d=t.width,g=t.height,s=o.getContext("2d"),u=(n*c-r)/2,h=(i*c-a)/2;s.clearRect(0,0,n*c,i*c),s.drawImage(t,0,0,d,g,u,h,r,a)}}function e(e){this._init(e)}var T,O,H,L;return e.prototype._init=function(e){var o=this;o._originOpts=e,Object.assign(o,d,e),o._uid=g++,o.debug&&console.log("开始构建裁剪..."),o._initCanvas(),o._observeImg(),o._redraw(),o._bindDrag(),a(o,"created")},(T=e).prototype.update=function(e){this.debug&&console.log("更新参数，重绘裁剪框"),Object.assign(this,e),this._redraw()},T.prototype.destroy=function(){var e=this;a(e,"beforeDestory"),function(e,o,t,n){void 0===n&&(n=!1);for(var i=u.length,r=[];i--;){var a=u[i],c=a.el,d=a.type,g=a.handler,s=a.options;(!e||e===c&&void 0===o||void 0===t&&o===d&&e===c||void 0===n&&o===d&&t===g&&e===c||o===d&&t===g&&n===s&&e===c)&&(r.push(i),c.removeEventListener(d,g,s))}r.forEach(function(e){u.splice(e,1)})}(),e.canvas=e.bufferCanvas=e._sourceImg=e._originOpts=null,a(e,"destoryed"),(e=null).debug&&console.log("销毁裁剪框")},T.prototype.reset=function(){this.debug&&console.log("重置裁剪框位置在画布中间"),r(this),this._redraw()},T.prototype.cut=function(){var e=this,o=e._sourceImg,t=e._imgWidth,n=e._imgHeight,i=e._zoom,r=e.cropperWidth,a=e.cropperHeight,c=e.width,d=e.height,g=e._x,s=e._y,u=e.imgType,h=e.quality,l=(r*i-t)/2,f=(a*i-n)/2,p=o.width,v=o.height,m=document.createElement("canvas"),b=m.getContext("2d");m.width=r*i,m.height=a*i,m.style.width=r+"px",m.style.height=a+"px",b.drawImage(o,0,0,p,v,l,f,t,n);var _=document.createElement("canvas"),y=_.getContext("2d");return _.width=c*i,_.height=d*i,_.style.width=c+"px",_.style.height=d+"px",y.putImageData(b.getImageData(g,s,c*i,d*i),0,0),m=b=y=null,e.debug&&console.warn("裁剪base64格式的图片，图片大小会受设备像素比影响，请注意设置图片尺寸"),_.toDataURL(u,h)},(O=e).prototype._initCanvas=function(){var e=this;a(e,"beforeCreate");var o,t=e.el;"string"===i(t)?(o=document.querySelector(t),e.debug&&o&&console.log("使用选择器查找画布元素：",o)):"object"===i(t)&&"canvas"===toLowerCase.call(t.nodeName)&&1===t.nodeType&&(o=t,e.debug&&o&&console.log("使用提供的画布元素：",o)),o||((o=document.createElement("canvas")).innerHTML="Your browser does not support canvas",e.debug&&console.log("传入的不是画布元素，创建一个新的画布元素：",o));var n="string"===i(t)?document.querySelector(t):t||null;n&&"object"===i(n)&&1===n.nodeType&&(n.appendChild(o),e.debug&&console.wran("将画布添加至el对应的元素,请注意设置样式")),e.canvas=o},O.prototype._resizeCanvas=function(){var e=this,o=e.canvas,t=e._zoom,n=e.cropperWidth,i=e.cropperHeight;h(o,n,i,t),o.style.width=n+"px",o.style.height=i+"px",e.debug&&console.log("重置画布大小为: "+n*t+"*"+i*t+";样式大小为："+n+"*"+i+"px")},O.prototype._offscreenBuffering=function(){var e=this,o=e.bufferCanvas||document.createElement("canvas"),t=o.getContext("2d"),n=e._zoom,i=h(o,e.cropperWidth,e.cropperHeight,n),r=i.zoomWidth,a=i.zoomHeight;t.clearRect(0,0,r,a),t.save(),t.fillStyle=e.shadowColor,t.fillRect(0,0,r,a),t.restore(),e.bufferCanvas||(e.bufferCanvas=o)},O.prototype._renderOffScreen=function(){var e=this,o=e.bufferCanvas,t=e.canvas,n=e.cropperWidth,i=e.cropperHeight,r=e._zoom,a=t.getContext("2d"),c=n*r,d=i*r;a.clearRect(0,0,c,d),a.drawImage(o,0,0,c,d,0,0,c,d)},e.prototype._bindDrag=function(){var e=this;t(window,"mousedown",l(e),!1),t(window,"mousemove",j(e),!1),t(window,"mouseup",S(e),!1),t(window,"touchstart",l(e),!1),t(window,"touchmove",j(e),!1),t(window,"touchend",S(e),!1)},L=null,(H=e).prototype._observeImg=function(){var o=this;Object.defineProperty(o,"_img",{set:function(e){e!==L&&(L=e,o._redraw())},get:function(){return L}})},H.prototype._redraw=function(){var e=this;e._zoom=function(){var e=document.createElement("canvas"),o=e.getContext("2d");return e=null,(window.devicePixelRatio||1)/(o.backingStorePixelRatio||o.webkitBackingStorePixelRadio||o.mozBackingStorePixelRadio||o.msBackingStorePixelRadio||o.oBackingStorePixedRadio||1)}(),e._resizeCanvas(),e._offscreenBuffering(e),function(e){var o=e.img;if(o&&o!==e._img)if(a(e,"beforeImgLoaded"),"string"===i(o)){var t=new Image;t.onload=function(){e._sourceImg=t,e._img=o,a(e,"imgLoaded")},o.crossOrigin="Anonymous",t.onerror=z,t.src=o}else"object"===i(o)&&"img"===W.call(o)&&1===o.nodeType?(o.onload=function(){e._sourceImg=o,e._img=o,a(e,"imgLoaded")},o.crossOrigin="Anonymous",o.onerror=z):z()}(e),I(e),n(e),e._renderOffScreen(),a(e,"onUpdate")},e.version="1.0.1",e});
