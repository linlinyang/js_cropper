!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).JSCropper=t()}(this,function(){"use strict";var t=Object.prototype.toString;function n(e){return{"[object Object]":"object","[object Array]":"array","[object Number]":"number","[object Boolean]":"boolean","[object String]":"string","[object Function]":"function","[object Undefined]":"undefined","[object Null]":"null"}[t.call(e)]}function p(e,t,o){var n=e.width,i=(e.height,e.getBoundingClientRect()),r=i.width;i.height;return{x:n/r*(t-i.left),y:n/r*(o-i.top)}}var c=Object.prototype.hasOwnProperty;function i(e,t){var o=e[t];"function"==typeof o&&o.call(e)}"function"!==n(Object.assign)&&Object.defineProperty(Object,"assign",{value:function(e){var t=arguments;if(null===n)return n;for(var o=arguments.length,n=Object(e),i=1;i<o;i++){var r=t[i];for(var a in r)c.call(r,a)&&(n[a]=r[a])}return n},writable:!0,configurable:!0,enumerable:!1});var o=1;function d(e,t,o,n){void 0===n&&(n=1);var i=e.getContext("2d"),r=t*n,a=o*n;return e.width=r,e.height=a,i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.msImageSmoothingEnabled=!1,i.imageSmoothingEnabled=!1,{zoomWidth:r,zoomHeight:a}}function r(e,t,o,n){void 0===n&&(n=!1),e.addEventListener(t,o,n)}function m(e){return e.changedTouches?e.changedTouches[0]:e}function v(e,t,o){var n=e.canvas,i=e._zoom,r=e.width,a=e.height,c=e._x,d=e._y;return c<t&&t<c+r*i&&d<o&&o<d+a*i?(n.style.cursor="move",!0):!(n.style.cursor="default")}var _=!1,b=0,y=0;function a(d){return function(e){var t=m(e),o=d.canvas,n=d._x,i=d._y,r=p(o,t.clientX,t.clientY),a=r.x,c=r.y;_=v(d,a,c),b=a-n,y=c-i}}function h(l){return function(e){var t=m(e),o=l.canvas,n=(l._x,l._y,l.width),i=l.height,r=l.cropperWidth,a=l.cropperHeight,c=l.edgeLineWidth,d=l._zoom,h=p(o,t.clientX,t.clientY),s=h.x,u=h.y,f=(r-n-c)*d,g=(a-i-c)*d;v(l,s,u),_&&(l._x=Math.min(0,Math.max(f,(s-b)*d)),l._y=Math.min(0,Math.max(g,(u-y)*d)),l._redraw())}}function s(){return function(e){_=!1}}var u=String.prototype.toLowerCase;function f(){throw i(jc,"imgLoaded"),new Error("Load image fail, please check your image")}function g(e,t){return Math.floor(e)+t%2/2}function w(e,t,o,n){void 0===n&&(n=!1);var i=e.lineWidth;n?e.moveTo(g(t,i),g(o,i)):e.moveTo(t,o)}function C(e,t,o,n){void 0===n&&(n=!1);var i=e.lineWidth;n?e.lineTo(g(t,i),g(o,i)):e.lineTo(t,o)}function x(e,t,o,n,i,r,a){void 0===r&&(r=!1),void 0===a&&(a=!1);var c=e.lineWidth,d=t+n,h=o+i;a&&(t=g(t,c),o=g(o,c),d=g(t+n,c),h=g(o+i,c)),r?(e.moveTo(t,o),e.lineTo(t,h),e.lineTo(d,h),e.lineTo(d,o)):(e.moveTo(t,o),e.lineTo(d,o),e.lineTo(d,h),e.lineTo(t,h)),e.closePath()}function j(e,t,o,n,i,r,a){void 0===r&&(r=5),void 0===a&&(a=!1);for(var c=function(e,t,o,n){return Math.sqrt(Math.pow(o-e,2)+Math.pow(n-t,2))}(t,o,n,i),d=Math.floor(c/r),h=(n-t)/d,s=(i-o)/d,u=0;u<d;u++){var f=t+u*h,g=o+u*s;1&u?C(e,f,g,a):w(e,f,g,a)}}function l(e){var t=e.bufferCanvas,o=e._x,n=e._y;e._zoom;void 0!==o&&void 0!==n||function(e){var t=e.width,o=e.height,n=e._zoom,i=e.cropperWidth,r=e.cropperHeight;e._x=(i-t)*n/2,e._y=(r-o)*n/2}(e);var i=t.getContext("2d");i.save(),function(e){var t=e.bufferCanvas,o=e.cropperWidth,n=e.cropperHeight,i=e.width,r=e.height,a=e._x,c=e._y,d=e._zoom,h=e.isDragging,s=t.getContext("2d");s.save(),s.beginPath(),x(s,0,0,o*d,n*d),x(s,a,c,i*d,r*d,!0),s.fillStyle=h?e.selectBackColor:e.inSelectBackColor,s.fill(),s.restore()}(e),function(e){var t=e.bufferCanvas,o=e.width,n=e.height,i=e._x,r=e._y,a=e._zoom,c=e.edgeLineColor,d=e.edgeLineWidth,h=t.getContext("2d"),s=o*a,u=n*a;h.strokeStyle=c,h.save(),h.lineWidth=Math.pow(a,2),x(h,i,r,s,u,!1,!0),j(h,i,r+u/3,i+s,r+u/3,5*a,!0),j(h,i,r+2*u/3,i+s,r+2*u/3,5*a,!0),j(h,i+s/3,r,i+s/3,r+u,5*a,!0),j(h,i+2*s/3,r,i+2*s/3,r+u,5*a,!0),h.stroke(),h.restore(),h.save();var f=d*a,g=i-(h.lineWidth=f)/2,l=r-f/2+1,p=i+s+f/2,m=r+u+f/2,v=.1*Math.min(s,u);h.beginPath(),w(h,g,l,!0),C(h,g+v,l,!0),w(h,p-v,l,!0),C(h,p,l,!0),C(h,p,l+v,!0),w(h,p,m-v,!0),C(h,p,m,!0),C(h,p-v,m,!0),w(h,g+v,m,!0),C(h,g,m,!0),C(h,1+g,m-v,!0),w(h,1+g,l+v,!0),C(h,1+g,l-f/2,!0),h.stroke(),h.restore()}(e),i.restore()}function e(e){this._init(e)}var S,z,W,T;return e.prototype._init=function(e){var t=this;t._originOpts=e,Object.assign(t,{cropperWidth:800,cropperHeight:600,width:300,height:300,shadowColor:"rgba(0,0,0,0.7)",edgeLineColor:"#fff",edgeLineWidth:3,dashLineColor:"rgba(255,255,255,0.8)",quality:1,imgType:"image/png",inSelectBackColor:"rgba(0,0,0,0.6)",selectBackColor:"rgba(0,0,0,0.2)"},e),t._uid=o++,t._initCanvas(),t._observeImg(),t._redraw(),t._bindDrag(),i(t,"created")},(S=e).prototype.update=function(e){i(this,"beforeUpdate"),0!==Object.keys(e)&&(Object.assign(this,e),this._redraw(),i(this,"updated"))},S.prototype.destroy=function(){i(this,"beforeDestory"),this.off()},S.prototype.reset=function(){i(this,"beforeReset")},(z=e).prototype._restore=function(){var e=this,t=e.ctx,o=e.cropperWidth*e._zoom,n=e.cropperHeight*e._zoom;e._imageSource=t.getImageData(0,0,o,n)},z.prototype._initCanvas=function(){i(this,"beforeCreate");var e,t=this.el;"string"===n(t)?e=document.querySelector(t):"object"===n(t)&&"canvas"===toLowerCase.call(t.nodeName)&&1===t.nodeType&&(e=t),e||((e=document.createElement("canvas")).innerHTML="Your browser does not support canvas");var o="string"===n(t)?document.querySelector(t):t||null;o&&"object"===n(o)&&1===o.nodeType&&o.appendChild(e),this.canvas=e},z.prototype._resizeCanvas=function(){var e=this.canvas,t=this._zoom,o=this.cropperWidth,n=this.cropperHeight;d(e,o,n,t),e.style.width=o+"px",e.style.height=n+"px"},z.prototype._offscreenBuffering=function(){var e=this,t=document.createElement("canvas"),o=t.getContext("2d"),n=e._zoom,i=d(t,e.cropperWidth,e.cropperHeight,n),r=i.zoomWidth,a=i.zoomHeight;o.clearRect(0,0,r,a),o.save(),o.fillStyle=e.shadowColor,o.fillRect(0,0,r,a),o.restore(),e.bufferCanvas=t,document.body.appendChild(t)},z.prototype._renderOffScreen=function(){var e=this,t=e.bufferCanvas,o=e.canvas,n=e.cropperWidth,i=e.cropperHeight,r=e._zoom,a=o.getContext("2d"),c=n*r,d=i*r;a.clearRect(0,0,c,d),a.drawImage(t,0,0,c,d,0,0,c,d)},e.prototype._bindDrag=function(){var e=this;r(window,"mousedown",a(e),!1),r(window,"mousemove",h(e),!1),r(window,"mouseup",s(),!1),r(window,"touchstart",a(e),!1),r(window,"touchmove",h(e),!1),r(window,"touchend",s(),!1)},T=null,(W=e).prototype._observeImg=function(){var t=this;Object.defineProperty(t,"_img",{set:function(e){e!==T&&(t._img=T=e,function(e){var t=e.cropperWidth,o=e.cropperHeight,n=e._zoom,i=e._sourceImg,r=i.width,a=i.height,c=Math.min(t/r,o/a);Object.assign(e,{_imgWidth:r*c*n,_imgHeight:a*c*n})}(t),function(e){var t=e.bufferCanvas,o=e._sourceImg,n=e.cropperWidth,i=e.cropperHeight,r=e._imgWidth,a=e._imgHeight,c=e._zoom,d=o.width,h=o.height,s=t.getContext("2d"),u=(n*c-r)/2,f=(i*c-a)/2;s.clearRect(0,0,n*c,i*c),s.drawImage(o,0,0,d,h,u,f,r,a)}(t),l(t),t._renderOffScreen())},get:function(){return T}})},W.prototype._redraw=function(){var e=this;e._zoom=function(){var e=document.createElement("canvas"),t=e.getContext("2d");return e=null,(window.devicePixelRatio||1)/(t.backingStorePixelRatio||t.webkitBackingStorePixelRadio||t.mozBackingStorePixelRadio||t.msBackingStorePixelRadio||t.oBackingStorePixedRadio||1)}(),e._resizeCanvas(),e._offscreenBuffering(e),function(e){var t=e.img||e.image;if(t&&t!==e._img)if(i(e,"beforeImgLoaded"),"string"===n(t)){var o=new Image;o.onload=function(){e._sourceImg=o,e._img=t},o.onerror=f,o.src=t}else"object"===n(t)&&"img"===u.call(t)&&1===t.nodeType?(t.onload=function(){e._sourceImg=t,e._img=t},t.onerror=f):f()}(e),l(e),e._renderOffScreen()},e.version="1.0.0",e});
