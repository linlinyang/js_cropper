!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).JSCropper=t()}(this,function(){"use strict";var t=Object.prototype.toString;function n(e){return{"[object Object]":"object","[object Array]":"array","[object Number]":"number","[object Boolean]":"boolean","[object String]":"string","[object Function]":"function","[object Undefined]":"undefined","[object Null]":"null"}[t.call(e)]}function f(e,t,o){var n=e.width,r=e.height,i=e.getBoundingClientRect(),a=i.width,c=i.height;return{x:n/a*(t-i.left),y:r/c*(o-i.top)}}var c=Object.prototype.hasOwnProperty;"function"!==n(Object.assign)&&Object.defineProperty(Object,"assign",{value:function(e){var t=arguments;if(null===n)return n;for(var o=arguments.length,n=Object(e),r=1;r<o;r++){var i=t[r];for(var a in i)c.call(i,a)&&(n[a]=i[a])}return n},writable:!0,configurable:!0,enumerable:!1});var u=[];function o(e,t,o,n){void 0===n&&(n=!1),e.addEventListener(t,o,n),u.push({el:e,type:t,handler:o,options:n})}function p(e){return e.changedTouches?e.changedTouches[0]:e}function s(e,t){return Math.floor(e)+t%2/2}function _(e,t,o,n){void 0===n&&(n=!1);var r=e.lineWidth;n?e.moveTo(s(t,r),s(o,r)):e.moveTo(t,o)}function b(e,t,o,n){void 0===n&&(n=!1);var r=e.lineWidth;n?e.lineTo(s(t,r),s(o,r)):e.lineTo(t,o)}function y(e,t,o,n,r,i,a){void 0===i&&(i=!1),void 0===a&&(a=!1);var c=e.lineWidth,d=t+n,g=o+r;a&&(t=s(t,c),o=s(o,c),d=s(t+n,c),g=s(o+r,c)),i?(e.moveTo(t,o),e.lineTo(t,g),e.lineTo(d,g),e.lineTo(d,o)):(e.moveTo(t,o),e.lineTo(d,o),e.lineTo(d,g),e.lineTo(t,g)),e.closePath()}function w(e,t,o,n,r,i,a){void 0===i&&(i=5),void 0===a&&(a=!1);for(var c=function(e,t,o,n){return Math.sqrt(Math.pow(o-e,2)+Math.pow(n-t,2))}(t,o,n,r),d=Math.floor(c/i),g=(n-t)/d,s=(r-o)/d,u=0;u<d;u++){var l=t+u*g,h=o+u*s;1&u?b(e,l,h,a):_(e,l,h,a)}}function r(e){var t=e.width,o=e.height,n=e._zoom,r=e.cropperWidth,i=e.cropperHeight;e._x=(r-t)*n/2,e._y=(i-o)*n/2}function i(e,t){var o=e.bufferCanvas;e._x,e._y;t&&r(e);var n=o.getContext("2d");n.save(),function(e){var t=e.bufferCanvas,o=e.cropperWidth,n=e.cropperHeight,r=e.width,i=e.height,a=e._x,c=e._y,d=e._zoom,g=e.isDragging,s=t.getContext("2d");s.save(),s.beginPath(),y(s,0,0,o*d,n*d),y(s,a,c,r*d,i*d,!0),s.fillStyle=g?e.selectBackColor:e.inSelectBackColor,s.fill(),s.restore()}(e),function(e){var t=e.bufferCanvas,o=e.width,n=e.height,r=e._x,i=e._y,a=e._zoom,c=e.edgeLineColor,d=e.edgeLineWidth,g=t.getContext("2d"),s=o*a,u=n*a;g.strokeStyle=c,g.save(),g.lineWidth=Math.pow(a,2),y(g,r,i,s,u,!1,!0),w(g,r,i+u/3,r+s,i+u/3,5*a,!0),w(g,r,i+2*u/3,r+s,i+2*u/3,5*a,!0),w(g,r+s/3,i,r+s/3,i+u,5*a,!0),w(g,r+2*s/3,i,r+2*s/3,i+u,5*a,!0),g.stroke(),g.restore(),g.save();var l=d*a,h=r-(g.lineWidth=l)/2,f=i-l/2+1,p=r+s+l/2,v=i+u+l/2,m=.1*Math.min(s,u);g.beginPath(),_(g,h,f,!0),b(g,h+m,f,!0),_(g,p-m,f,!0),b(g,p,f,!0),b(g,p,f+m,!0),_(g,p,v-m,!0),b(g,p,v,!0),b(g,p-m,v,!0),_(g,h+m,v,!0),b(g,h,v,!0),b(g,1+h,v-m,!0),_(g,1+h,f+m,!0),b(g,1+h,f-l/2,!0),g.stroke(),g.restore()}(e),n.restore()}function a(e,t){var o=e[t];"function"==typeof o&&o.call(e)}var d={cropperWidth:800,cropperHeight:600,width:300,height:300,shadowColor:"rgba(0,0,0,0.7)",edgeLineColor:"#fff",edgeLineWidth:3,dashLineColor:"rgba(255,255,255,0.8)",quality:1,imgType:"image/png",inSelectBackColor:"rgba(0,0,0,0.6)",selectBackColor:"rgba(0,0,0,0.4)",debug:!1};var g=1;function l(e,t,o,n){void 0===n&&(n=1);var r=e.getContext("2d"),i=t*n,a=o*n;return e.width=i,e.height=a,r.mozImageSmoothingEnabled=!1,r.webkitImageSmoothingEnabled=!1,r.msImageSmoothingEnabled=!1,r.imageSmoothingEnabled=!1,{zoomWidth:i,zoomHeight:a}}var h=String.prototype.toLowerCase;function v(e,t,o){var n=e.canvas,r=e._zoom,i=e.width,a=e.height,c=e._x,d=e._y;return c<t&&t<c+i*r&&d<o&&o<d+a*r?(n.style.cursor="move",!0):!(n.style.cursor="default")}var m=!1,x=0,C=0;function T(d){return function(e){var t=p(e),o=d.canvas,n=d._x,r=d._y,i=f(o,t.clientX,t.clientY),a=i.x,c=i.y;m=v(d,a,c),x=a-n,C=c-r,d.isDragging=m}}function j(h){return function(e){var t=p(e),o=h.canvas,n=h.width,r=h.height,i=h.cropperWidth,a=h.cropperHeight,c=h._zoom,d=f(o,t.clientX,t.clientY),g=d.x,s=d.y,u=(i-n)*c,l=(a-r)*c;v(h,g,s),m&&(h._x=Math.max(0,Math.min(u,g-x)),h._y=Math.max(0,Math.min(l,s-C)),h._redraw(),h.debug&&console.log("拖动裁剪框：(X: "+h._x+", Y: "+h._y+")"))}}function S(t){return function(e){t.isDragging=m=!1,t._redraw()}}var W=String.prototype.toLowerCase;function I(){throw a(jc,"imgLoaded"),new Error("Load image fail, please check your image")}function z(e){if(e._sourceImg){!function(e){if(e._sourceImg){var t=e.cropperWidth,o=e.cropperHeight,n=e._zoom,r=e._sourceImg,i=r.width,a=r.height,c=Math.min(t/i,o/a);Object.assign(e,{_imgWidth:i*c*n,_imgHeight:a*c*n})}}(e);var t=e.bufferCanvas,o=e._sourceImg,n=e.cropperWidth,r=e.cropperHeight,i=e._imgWidth,a=e._imgHeight,c=e._zoom,d=o.width,g=o.height,s=t.getContext("2d"),u=(n*c-i)/2,l=(r*c-a)/2;s.clearRect(0,0,n*c,r*c),s.drawImage(o,0,0,d,g,u,l,i,a)}}function e(e){this._init(e)}var H,L,O,B;return e.prototype._init=function(e){var t=this;t._originOpts=e,Object.assign(t,d,e),t._uid=g++,t.debug&&console.log("开始构建裁剪..."),t._initCanvas(),t._observeImg(),t._redraw(!0),t._bindDrag(),a(t,"created")},(H=e).prototype.update=function(e){this.debug&&console.log("更新参数，重绘裁剪框"),Object.assign(this,e),this._redraw(!0)},H.prototype.destroy=function(){var e=this;a(e,"beforeDestory"),function(e,t,o,n){void 0===n&&(n=!1);for(var r=u.length,i=[];r--;){var a=u[r],c=a.el,d=a.type,g=a.handler,s=a.options;(!e||e===c&&void 0===t||void 0===o&&t===d&&e===c||void 0===n&&t===d&&o===g&&e===c||t===d&&o===g&&n===s&&e===c)&&(i.push(r),c.removeEventListener(d,g,s))}i.forEach(function(e){u.splice(e,1)})}(),e.canvas=e.bufferCanvas=e._sourceImg=e._originOpts=null,a(e,"destoryed"),(e=null).debug&&console.log("销毁裁剪框")},H.prototype.reset=function(){this.debug&&console.log("重置裁剪框位置在画布中间"),r(this),this._redraw()},H.prototype.cut=function(){var e=this,t=e._sourceImg,o=e._imgWidth,n=e._imgHeight,r=e._zoom,i=e.cropperWidth,a=e.cropperHeight,c=e.width,d=e.height,g=e._x,s=e._y,u=e.imgType,l=e.quality,h=(i*r-o)/2,f=(a*r-n)/2,p=t.width,v=t.height,m=document.createElement("canvas"),_=m.getContext("2d");m.width=i*r,m.height=a*r,m.style.width=i+"px",m.style.height=a+"px",_.drawImage(t,0,0,p,v,h,f,o,n);var b=document.createElement("canvas"),y=b.getContext("2d");b.width=c*r,b.height=d*r,b.style.width=c+"px",b.style.height=d+"px",y.putImageData(_.getImageData(g,s,c*r,d*r),0,0),m=_=y=null,e.debug&&console.warn("裁剪base64格式的图片，图片大小会受设备像素比影响，请注意设置图片尺寸");var w=b.toDataURL(u,l);if(e.debug){var x=w.replace("data:"+e.imgType+";base64,","");console.log("获得的裁剪图片尺寸："+function(e){for(var t=parseInt(e-e/8*2),o=["Bit","KB","MB","GB","TB"],n=o.length,r=0;r<n;r++)if(t>>10*r<1024)return(t/1024).toFixed(1)+o[r];return"too large"}(x.length)),console.log("裁剪图片大小："+c*r+"×"+d*r+"像素")}return w},(L=e).prototype._initCanvas=function(){var e=this;a(e,"beforeCreate");var t=e.el,o="string"==typeof t?document.querySelector(t):function(e){return e instanceof HTMLCanvasElement}(t)&&t;if(o&&"canvas"===h.call(o.nodeName)&&1===o.nodeType)return e.canvas=o,void(e.debug&&console.log("使用传入的canvas元素",o));var n=document.createElement("canvas");n.innerHTML="你的浏览器不支持画布元素",e.debug&&console.log("创建一个新的画布元素：",n),e.canvas=n;var r="string"==typeof t?document.querySelector(t):function(e){return e instanceof HTMLElement}(t)&&t;r&&1===r.nodeType&&(r.appendChild(n),e.debug&&console.wran("将画布添加至el对应的元素,请注意设置样式"))},L.prototype._resizeCanvas=function(){var e=this,t=e.canvas,o=e._zoom,n=e.cropperWidth,r=e.cropperHeight;l(t,n,r,o),t.style.width=n+"px",t.style.height=r+"px",e.debug&&console.log("重置画布大小为: "+n*o+"*"+r*o+";样式大小为："+n+"*"+r+"px")},L.prototype._offscreenBuffering=function(){var e=this,t=e.bufferCanvas||document.createElement("canvas"),o=t.getContext("2d"),n=e._zoom,r=l(t,e.cropperWidth,e.cropperHeight,n),i=r.zoomWidth,a=r.zoomHeight;o.clearRect(0,0,i,a),o.save(),o.fillStyle=e.shadowColor,o.fillRect(0,0,i,a),o.restore(),e.bufferCanvas||(e.bufferCanvas=t)},L.prototype._renderOffScreen=function(){var e=this,t=e.bufferCanvas,o=e.canvas,n=e.cropperWidth,r=e.cropperHeight,i=e._zoom,a=o.getContext("2d"),c=n*i,d=r*i;a.clearRect(0,0,c,d),a.drawImage(t,0,0,c,d,0,0,c,d)},e.prototype._bindDrag=function(){var e=this;o(window,"mousedown",T(e),!1),o(window,"mousemove",j(e),!1),o(window,"mouseup",S(e),!1),o(window,"touchstart",T(e),!1),o(window,"touchmove",j(e),!1),o(window,"touchend",S(e),!1)},B=null,(O=e).prototype._observeImg=function(){var t=this;Object.defineProperty(t,"_img",{set:function(e){e!==B&&(B=e,t._redraw())},get:function(){return B}})},O.prototype._redraw=function(e){void 0===e&&(e=!1);var t=this;e&&(t._zoom=function(){var e=document.createElement("canvas"),t=e.getContext("2d");return e=null,(window.devicePixelRatio||1)/(t.backingStorePixelRatio||t.webkitBackingStorePixelRadio||t.mozBackingStorePixelRadio||t.msBackingStorePixelRadio||t.oBackingStorePixedRadio||1)}(),t._resizeCanvas(),t._offscreenBuffering(t)),function(e){var t=e.img;if(t&&t!==e._img)if(a(e,"beforeImgLoaded"),"string"===n(t)){var o=new Image;o.onload=function(){e._sourceImg=o,e._img=t,a(e,"imgLoaded")},o.crossOrigin="Anonymous",o.onerror=I,o.src=t}else"object"===n(t)&&"img"===W.call(t)&&1===t.nodeType?(t.onload=function(){e._sourceImg=t,e._img=t,a(e,"imgLoaded")},t.crossOrigin="Anonymous",t.onerror=I):I()}(t),z(t),i(t,e),t._renderOffScreen(),a(t,"onUpdate")},e.version="1.1.0",e});
